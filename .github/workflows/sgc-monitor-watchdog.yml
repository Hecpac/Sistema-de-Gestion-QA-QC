name: SGC Monitor Watchdog

on:
  schedule:
    - cron: "0 15 * * *" # Daily 15:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  issues: write

jobs:
  watchdog:
    runs-on: ubuntu-latest

    steps:
      - name: Check last weekly monitor run
        uses: actions/github-script@v7
        with:
          script: |
            const workflowFile = "sgc-weekly-monitor.yml";
            const maxAgeDays = 8;

            const { owner, repo } = context.repo;
            const now = new Date();

            async function createWatchdogIssue(title, body) {
              const existing = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: "open",
                labels: "sgc,monitor",
                per_page: 50,
              });

              const already = (existing.data || []).some(i => (i.title || "") === title);
              if (already) {
                core.warning("Ya existe un issue abierto del watchdog con labels sgc,monitor. No se crea uno nuevo.");
                return false;
              }

              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: ["sgc", "monitor", "qa"],
              });

              return true;
            }

            const runsResp = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              per_page: 5,
            });

            const runs = runsResp.data.workflow_runs || [];
            if (!runs.length) {
              const title = `[SGC Watchdog] Weekly monitor sin runs`;
              const body = [
                `El watchdog detecto que ${workflowFile} no tiene ejecuciones registradas.`,
                ``,
                `- Workflow: ${workflowFile}`,
                `- Fecha deteccion: ${now.toISOString()}`,
                ``,
                `Accion recomendada: ejecutar el workflow manualmente y confirmar que el schedule quede activo.`,
              ].join("\n");

              try {
                const created = await createWatchdogIssue(title, body);
                core.setFailed(
                  created
                    ? `No hay runs para ${workflowFile}. Se creo issue del watchdog.`
                    : `No hay runs para ${workflowFile}. Ya existe issue watchdog abierto.`
                );
              } catch (error) {
                core.error(error);
                core.setFailed(`No hay runs para ${workflowFile} y fallo la creacion de issue watchdog: ${error.message}`);
              }
              return;
            }

            const last = runs[0];
            if (!last || !last.created_at) {
              core.setFailed(`Respuesta inesperada de GitHub Actions para ${workflowFile}.`);
              return;
            }

            const lastTime = new Date(last.created_at);
            const ageMs = now - lastTime;
            const ageDays = ageMs / (1000 * 60 * 60 * 24);

            const ok = last.conclusion === "success" && ageDays <= maxAgeDays;
            if (ok) {
              core.info(`OK: ultimo run ${workflowFile} (${last.id}) conclusion=${last.conclusion} ageDays=${ageDays.toFixed(2)}`);
              return;
            }

            const title = `[SGC Watchdog] Weekly monitor stale/failing`;
            const body = [
              `El watchdog detecto que el monitor semanal no esta saludable.`,
              ``,
              `- Workflow: ${workflowFile}`,
              `- Fecha deteccion: ${now.toISOString()}`,
              `- Ultimo run: ${last.html_url}`,
              `- Conclusion: ${last.conclusion}`,
              `- Creado: ${last.created_at}`,
              `- Umbral maxAgeDays: ${maxAgeDays}`,
              ``,
              `Accion recomendada: revisar el run, artifacts y ejecutar monitor localmente si aplica.`,
              `Si el problema es que no hay ejecuciones recientes, verificar que el schedule de Actions este habilitado.`,
            ].join("\n");

            try {
              const created = await createWatchdogIssue(title, body);
              core.setFailed(
                created
                  ? "Watchdog detecto problema y creo issue."
                  : "Watchdog detecto problema (issue existente)."
              );
            } catch (error) {
              core.error(error);
              core.setFailed(`Watchdog detecto problema y fallo la creacion de issue: ${error.message}`);
            }