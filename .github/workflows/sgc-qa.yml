name: SGC QA Gate

on:
  pull_request:
  push:
    branches:
      - main
      - master

jobs:
  qa:
    name: SGC QA Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install -c ./agent_runtime/constraints-ci.txt -e ./agent_runtime
          pip install -c ./agent_runtime/constraints-ci.txt pytest

      - name: Run unit tests (P1..P5 + regressions + zero-trust)
        run: pytest -q agent_runtime/tests

      - name: Rebuild control indexes and dashboard
        run: |
          sgc-build-indexes --repo-root "$GITHUB_WORKSPACE"
          sgc-build-dashboard --repo-root "$GITHUB_WORKSPACE"

      - name: Anti-drift check (artefactos generados no deben tener drift)
        run: |
          git diff --exit-code -- docs/_control/lmd.yml docs/_control/matriz_registros.yml docs/_control/dashboard_sgc.html

      - name: Link integrity audit (AST) with lychee
        uses: lycheeverse/lychee-action@v2
        with:
          args: --config ./.lychee.toml --verbose --no-progress "./**/*.md"
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate required sections in controlled docs (PR blocker)
        env:
          PYTHONPATH: agent_runtime
          SGC_REPO_ROOT: ${{ github.workspace }}
        run: |
          python - <<'PY'
          import sys
          from sgc_agents.tools.build_indexes import discover_controlled_documents
          from sgc_agents.tools.document_tools import validate_required_sections_impl
          from sgc_agents.config import repo_root

          errors = []
          for doc in discover_controlled_documents(repo_root().resolve()):
              if doc.frontmatter.estado != "VIGENTE":
                  continue
              result = validate_required_sections_impl(doc.relative_path)
              if result != "OK":
                  errors.append(f"{doc.frontmatter.codigo} ({doc.relative_path}): {result}")

          if errors:
              print("ERROR: Documentos VIGENTE sin secciones obligatorias:", file=sys.stderr)
              for e in errors:
                  print(f"  - {e}", file=sys.stderr)
              sys.exit(1)

          print(f"OK: secciones minimas verificadas en {len([d for d in discover_controlled_documents(repo_root().resolve()) if d.frontmatter.estado == 'VIGENTE'])} docs VIGENTE.")
          PY

      - name: Run deterministic QA gate
        env:
          PYTHONPATH: agent_runtime
          SGC_REPO_ROOT: ${{ github.workspace }}
        run: |
          python - <<'PY'
          import sys
          import yaml
          from sgc_agents.tools.compliance_tools import (
              auditar_invariantes_de_estado,
              auditar_claves_frontmatter_desconocidas,
              auditar_secciones_minimas,
              auditar_enlaces_markdown,
              auditar_catalogo_registros,
              resolver_grafo_documental,
              detectar_formatos_huerfanos,
              auditar_trazabilidad_registros,
              generar_reporte_qa_compliance,
          )

          print(generar_reporte_qa_compliance())

          checks = [
              yaml.safe_load(auditar_invariantes_de_estado()) or {},
              yaml.safe_load(auditar_claves_frontmatter_desconocidas()) or {},
              yaml.safe_load(auditar_secciones_minimas()) or {},
              yaml.safe_load(auditar_enlaces_markdown()) or {},
              yaml.safe_load(auditar_catalogo_registros()) or {},
              yaml.safe_load(resolver_grafo_documental()) or {},
              yaml.safe_load(detectar_formatos_huerfanos()) or {},
              yaml.safe_load(auditar_trazabilidad_registros()) or {},
          ]

          total_findings = 0
          for check in checks:
              findings = check.get("hallazgos", [])
              if isinstance(findings, list):
                  total_findings += len(findings)

          if total_findings:
              print(f"QA gate failed. Hallazgos totales: {total_findings}", file=sys.stderr)
              sys.exit(1)

          print("QA gate passed with 0 hallazgos.")
          PY
