name: SGC Baseline Gate (Strict)

on:
  push:
    tags:
      - "sgc-*"
  workflow_dispatch:

jobs:
  baseline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install -c ./agent_runtime/constraints-ci.txt -e ./agent_runtime
          pip install -c ./agent_runtime/constraints-ci.txt pytest

      - name: Run unit tests (P1..P5 + regressions)
        run: pytest -q agent_runtime/tests

      - name: Rebuild control indexes and dashboard
        run: |
          sgc-build-indexes --repo-root "$GITHUB_WORKSPACE"
          sgc-build-dashboard --repo-root "$GITHUB_WORKSPACE"

      - name: Verify generated artifacts are up to date
        run: |
          git diff --exit-code -- docs/_control/lmd.yml docs/_control/matriz_registros.yml docs/_control/dashboard_sgc.html

      - name: Run strict baseline gate (0 hallazgos + 0 BORRADOR + 0 pendientes matriz)
        env:
          PYTHONPATH: agent_runtime
          SGC_REPO_ROOT: ${{ github.workspace }}
        run: |
          python - <<'PY'
          import sys
          from pathlib import Path
          import yaml

          from sgc_agents.tools.compliance_tools import (
              auditar_invariantes_de_estado,
              auditar_claves_frontmatter_desconocidas,
              auditar_secciones_minimas,
              auditar_enlaces_markdown,
              auditar_catalogo_registros,
              resolver_grafo_documental,
              detectar_formatos_huerfanos,
              auditar_trazabilidad_registros,
              auditar_pendientes_matriz_registros,
          )

          lmd = yaml.safe_load(Path("docs/_control/lmd.yml").read_text(encoding="utf-8")) or {}
          docs = lmd.get("documentos", []) if isinstance(lmd, dict) else []
          borradores = [d for d in docs if isinstance(d, dict) and str(d.get("estado", "")).strip() == "BORRADOR"]
          if borradores:
              print(f"Baseline gate failed. Documentos BORRADOR={len(borradores)}", file=sys.stderr)
              for d in borradores[:25]:
                  print(f"- {d.get('codigo','?')} | {d.get('ubicacion','?')}", file=sys.stderr)
              sys.exit(1)

          checks = [
              yaml.safe_load(auditar_invariantes_de_estado()) or {},
              yaml.safe_load(auditar_claves_frontmatter_desconocidas()) or {},
              yaml.safe_load(auditar_secciones_minimas()) or {},
              yaml.safe_load(auditar_enlaces_markdown()) or {},
              yaml.safe_load(auditar_catalogo_registros()) or {},
              yaml.safe_load(resolver_grafo_documental()) or {},
              yaml.safe_load(detectar_formatos_huerfanos()) or {},
              yaml.safe_load(auditar_trazabilidad_registros()) or {},
              yaml.safe_load(auditar_pendientes_matriz_registros()) or {},
          ]

          total_findings = 0
          for check in checks:
              findings = check.get("hallazgos", [])
              if isinstance(findings, list):
                  total_findings += len(findings)

          if total_findings:
              print(f"Baseline gate failed. Hallazgos totales: {total_findings}", file=sys.stderr)
              sys.exit(1)

          print("Baseline gate passed with 0 hallazgos, 0 BORRADOR, 0 pendientes matriz.")
          PY
